#!/bin/bash
# Usage: ./run <command> [args...]

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    echo -e "${BLUE}➜${NC} $1"
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_error() {
    echo -e "${RED}❌${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

# Function to show help
show_help() {
    cat << EOF

Usage: ./run <command> [args...]

Docker Commands:
  build                    Build Docker image (make docker-build)
  secret                   Create local .eth_secret file (make docker-secret)
  secret-remove            Remove existing Docker Swarm secret (make docker-secret-remove)
  run [ARGS]               Run container (make docker-run)
                           UI mode by default, CLI mode with ARGS
  clean                    Remove Docker resources (make docker-clean)
  swarm                    Deploy to Docker Swarm with secrets (make docker-swarm)
  logs                     View Swarm service logs (make docker-logs)
  down                     Remove Swarm stack (make docker-down)

Examples:
  ./run build                           # Build Docker image
  ./run secret                          # Create local secret file
  ./run run                             # Run UI mode (interactive)
  ARGS="--help" ./run run              # Run CLI mode with help
  ARGS="sign --help" ./run run          # Show sign command help
  ./run clean                           # Clean Docker resources
  ./run swarm                           # Deploy to Docker Swarm

For more options, see: make help
EOF
}

# Function to check if make is available
check_make() {
    if ! command -v make &> /dev/null; then
        print_error "make command not found. Please install make."
        exit 1
    fi
}

# Function to check if docker is available
check_docker() {
    if ! command -v docker &> /dev/null; then
        print_error "docker command not found. Please install Docker."
        exit 1
    fi
}

# Function to run make command
run_make() {
    local target="$1"
    shift
    print_status "Running: make $target $*"
    if make "$target" "$@"; then
        print_success "Command completed successfully"
    else
        print_error "Command failed"
        exit 1
    fi
}

# Main script logic
main() {
    # Check dependencies
    check_make
    check_docker

    # Get command
    case "${1:-}" in
        "build")
            run_make "docker-build"
            ;;
        "secret")
            run_make "docker-secret"
            ;;
        "secret-remove")
            run_make "docker-secret-remove"
            ;;
        "run")
            shift
            if [ -n "$ARGS" ]; then
                run_make "docker-run"
            else
                run_make "docker-run"
            fi
            ;;
        "clean")
            run_make "docker-clean"
            ;;
        "swarm")
            run_make "docker-swarm"
            ;;
        "logs")
            run_make "docker-logs"
            ;;
        "down")
            run_make "docker-down"
            ;;
        "help"|"-h"|"--help")
            show_help
            ;;
        "")
            print_error "No command specified."
            show_help
            exit 1
            ;;
        *)
            print_error "Unknown command: $1"
            show_help
            exit 1
            ;;
    esac
}

# Run main function with all arguments
main "$@"